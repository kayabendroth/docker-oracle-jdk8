machine:
  services:
    - docker

dependencies:
  cache_directories:
    - ~/.docker
  post:
    # Cache Docker image layers.
    - circleci/scripts/docker-cache-layers.sh -d ~/.docker

test:
  override:
    # Test building the Docker image.
    - docker build -t kayabendroth/oracle-jdk8:latest .
    # Check if 'java' and 'javac' can be called w/o errors.
    - docker run --rm -t -i kayabendroth/oracle-jdk8:latest java -version
    - docker run --rm -t -i kayabendroth/oracle-jdk8:latest javac -version

deployment:
  automerge:
    branch: dev
    commands:
      - circleci/scripts/merge_to_master.sh

  hub:
    branch: master
    commands:
      - docker login -u "${DOCKER_LOGIN_USERNAME}" -p "${DOCKER_LOGIN_PASSWORD}" -e "${DOCKER_LOGIN_EMAIL}"
      - docker tag -f "`docker images | grep 'kayabendroth/oracle-jdk8:latest' | awk '{ print $3 }'`" kayabendroth/oracle-jdk8:oracle-jdk8
      - docker push kayabendroth/oracle-jdk8

